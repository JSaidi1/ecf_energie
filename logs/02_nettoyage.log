2026-02-21 09:54:04,112 - [INFO] - ===============================================================================================
2026-02-21 09:54:04,115 - [INFO] -                Logs de traitement (nettoyage) - script: 02_nettoyage_spark.py
2026-02-21 09:54:04,118 - [INFO] -                          Etape 1.2 - Pipeline de nettoyage Spark
2026-02-21 09:54:04,121 - [INFO] - ===============================================================================================
2026-02-21 09:54:06,134 - [INFO] - Ressources actuellement disponibles sur la machine :
2026-02-21 09:54:08,148 - [INFO] - RAM actuellement disponible sur la machine (free) : 13.49 GB
2026-02-21 09:54:08,152 - [INFO] - CPU actuellement disponible sur la machine (free) : 99.9%
2026-02-21 09:54:08,156 - [INFO] -         Approx logical cores  (free) : 15.98
2026-02-21 09:54:08,160 - [INFO] -         Approx physical cores (free) : 7.99
2026-02-21 09:54:08,164 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 09:54:08,168 - [INFO] - Creation d'une session Spark ...
2026-02-21 09:54:09,023 - [INFO] - Spark version  : 3.5.3
2026-02-21 09:54:09,033 - [INFO] - Spark UI       : http://spark-master:4040
2026-02-21 09:54:09,038 - [INFO] - Python version : 3.8.10
2026-02-21 09:54:09,044 - [INFO] - Python path    : /usr/bin/python3
2026-02-21 09:54:09,054 - [INFO] - Java version   : 11.0.24
2026-02-21 09:54:09,061 - [INFO] - Java home      : /opt/java/openjdk
2026-02-21 09:54:09,066 - [INFO] - [ok]: creation de la session Spark avec succès
2026-02-21 09:54:09,071 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 09:54:09,076 - [INFO] - Enregistrement des udf parse_timestamp_udf & clean_consommation_udf
2026-02-21 09:54:10,593 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 09:54:10,607 - [INFO] - [1/5] Chargement des donnees brutes ...
2026-02-21 09:54:10,615 - [INFO] - Creation de df_conso_raw (à partir consommations_raw.csv)
2026-02-21 09:54:21,839 - [INFO] -     - Lignes en entree : 7,758,868
2026-02-21 09:54:21,861 - [INFO] -     - Nombre de colonnes : 5
2026-02-21 09:54:21,865 - [INFO] -     - Schema :
2026-02-21 09:54:21,870 - [INFO] - 
root
 |-- batiment_id: string (nullable = true)
 |-- timestamp: string (nullable = true)
 |-- type_energie: string (nullable = true)
 |-- consommation: string (nullable = true)
 |-- unite: string (nullable = true)

2026-02-21 09:54:22,042 - [INFO] - ---
2026-02-21 09:54:22,046 - [INFO] - Creation de df_bat (à partir batiments.csv)
2026-02-21 09:54:22,344 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 09:54:22,350 - [INFO] - [2/5] Nettoyage ...
2026-02-21 09:54:22,356 - [INFO] - Nettoyage à partir de la colonne timestamps
2026-02-21 09:54:22,362 - [INFO] - Conversion timestamp(string) => nouvelle colonne timestamp_parsed (TimestampType) => parse_timestamp_udf
2026-02-21 09:54:22,416 - [INFO] - Suppression des lignes où timestamp_parsed est NULL
2026-02-21 09:55:11,980 - [INFO] - Timestamps invalides supprimes: 0
2026-02-21 09:55:11,985 - [INFO] - ---
2026-02-21 09:55:11,989 - [INFO] - Nettoyage à partir de la colonne consommation
2026-02-21 09:55:11,994 - [INFO] - Conversion consommation (string) => nouvelle colonne consommation_clean (DoubleType) => clean_consommation_udf
2026-02-21 09:55:12,018 - [INFO] - Suppression des valeurs négatives (consommation_clean < 0) & nulles (consommation_clean = NULL)
2026-02-21 09:56:57,542 - [INFO] - Nombre des valeurs negatives supprimees : 38,910
2026-02-21 09:56:57,546 - [INFO] - Nombre des valeurs nulles supprimees : 38,975
2026-02-21 09:56:57,549 - [INFO] - Suppression des outliers (consommation_clean > 10000)
2026-02-21 09:57:51,423 - [INFO] - Nombre des outliers (>10000) supprimes : 38,560
2026-02-21 09:57:51,429 - [INFO] - ---
2026-02-21 09:57:51,435 - [INFO] - Nettoyage des doublons (Deduplication sur (batiment_id, timestamp, type_energie))
2026-02-21 10:00:03,530 - [INFO] - Nombre de doublons supprimes : 646,475
2026-02-21 10:00:03,536 - [INFO] - ---
2026-02-21 10:00:03,541 - [INFO] - Description de df_conso_clean après le nettoyage complet :
2026-02-21 10:01:21,179 - [INFO] -     - Nombre de lignes : 6,995,948
2026-02-21 10:01:21,186 - [INFO] -     - Nombre de colonnes : 7
2026-02-21 10:01:21,190 - [INFO] -     - Schema :
2026-02-21 10:01:21,195 - [INFO] - 
root
 |-- batiment_id: string (nullable = true)
 |-- timestamp: string (nullable = true)
 |-- type_energie: string (nullable = true)
 |-- consommation: string (nullable = true)
 |-- unite: string (nullable = true)
 |-- timestamp_parsed: timestamp (nullable = true)
 |-- consommation_clean: double (nullable = true)

2026-02-21 10:02:44,819 - [INFO] -     - Appercu des données (df_conso_clean):
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|    | batiment_id   | timestamp           | type_energie   | consommation   | unite   | timestamp_parsed    |   consommation_clean |
+====+===============+=====================+================+================+=========+=====================+======================+
|  0 | BAT0001       | 2023-01-01 01:00:00 | eau            | 0.26           | m3      | 2023-01-01 01:00:00 |                 0.26 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  1 | BAT0001       | 01/01/2023 01:00    | electricite    | 7.55           | kWh     | 2023-01-01 01:00:00 |                 7.55 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  2 | BAT0001       | 01/01/2023 01:00    | gaz            | 9.58           | kWh     | 2023-01-01 01:00:00 |                 9.58 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  3 | BAT0001       | 2023-01-01 04:00:00 | gaz            | 8,02           | kWh     | 2023-01-01 04:00:00 |                 8.02 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  4 | BAT0001       | 2023-01-01T07:00:00 | eau            | 2.28           | m3      | 2023-01-01 07:00:00 |                 2.28 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  5 | BAT0001       | 2023-01-01 08:00:00 | gaz            | 111.51         | kWh     | 2023-01-01 08:00:00 |               111.51 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  6 | BAT0001       | 2023-01-01T10:00:00 | electricite    | 83.05          | kWh     | 2023-01-01 10:00:00 |                83.05 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  7 | BAT0001       | 2023-01-01 17:00:00 | eau            | 2.60           | m3      | 2023-01-01 17:00:00 |                 2.6  |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  8 | BAT0001       | 2023-01-01T20:00:00 | electricite    | 73.49          | kWh     | 2023-01-01 20:00:00 |                73.49 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
|  9 | BAT0001       | 2023-01-01 23:00:00 | eau            | 0.20           | m3      | 2023-01-01 23:00:00 |                 0.2  |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+
2026-02-21 10:02:44,823 - [INFO] - ---
2026-02-21 10:02:44,827 - [INFO] - Global checks de la df_conso_clean après nettoyage :
2026-02-21 10:02:44,830 - [INFO] - 
2026-02-21 10:02:44,833 - [INFO] - check de la colonne timestamp_parsed :
2026-02-21 10:03:36,814 - [INFO] - [ok]: Après nettoyage, df_conso_clean ne contient plus des lignes avec timestamp_parsed nulles : 0
2026-02-21 10:03:36,824 - [INFO] - 
2026-02-21 10:03:36,831 - [INFO] - check de la colonne consommation_clean :
2026-02-21 10:04:52,536 - [INFO] - [ok]: Après nettoyage, df_conso_clean ne contient plus des lignes avec consommation_clean nulles : 0
2026-02-21 10:06:08,678 - [INFO] - [ok]: Après nettoyage, df_conso_clean ne contient plus des lignes avec consommation_clean < 0 : 0
2026-02-21 10:07:25,069 - [INFO] - [ok]: Après nettoyage, df_conso_clean ne contient plus des lignes avec consommation_clean > 10000 (outliers) : 0
2026-02-21 10:07:25,074 - [INFO] - 
2026-02-21 10:07:25,077 - [INFO] - Check des doublons :
2026-02-21 10:08:41,785 - [INFO] - [ok]: Après nettoyage, df_conso_clean ne contient plus des lignes dupliquées (en 'batiment_id', 'timestamp_parsed', 'type_energie') : 0
2026-02-21 10:08:41,789 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 10:08:41,793 - [INFO] - [3/5] Enrichissement temporel (pour preparer les agregations) ...
2026-02-21 10:10:01,224 - [INFO] - Apperçu de la df_with_time :
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|    | batiment_id   | timestamp           | type_energie   | consommation   | unite   | timestamp_parsed    |   consommation_clean | date       |   heure |   annee |   mois |
+====+===============+=====================+================+================+=========+=====================+======================+============+=========+=========+========+
|  0 | BAT0001       | 2023-01-01 01:00:00 | eau            | 0.26           | m3      | 2023-01-01 01:00:00 |                 0.26 | 2023-01-01 |       1 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  1 | BAT0001       | 01/01/2023 01:00    | electricite    | 7.55           | kWh     | 2023-01-01 01:00:00 |                 7.55 | 2023-01-01 |       1 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  2 | BAT0001       | 01/01/2023 01:00    | gaz            | 9.58           | kWh     | 2023-01-01 01:00:00 |                 9.58 | 2023-01-01 |       1 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  3 | BAT0001       | 2023-01-01 04:00:00 | gaz            | 8,02           | kWh     | 2023-01-01 04:00:00 |                 8.02 | 2023-01-01 |       4 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  4 | BAT0001       | 2023-01-01T07:00:00 | eau            | 2.28           | m3      | 2023-01-01 07:00:00 |                 2.28 | 2023-01-01 |       7 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  5 | BAT0001       | 2023-01-01 08:00:00 | gaz            | 111.51         | kWh     | 2023-01-01 08:00:00 |               111.51 | 2023-01-01 |       8 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  6 | BAT0001       | 2023-01-01T10:00:00 | electricite    | 83.05          | kWh     | 2023-01-01 10:00:00 |                83.05 | 2023-01-01 |      10 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  7 | BAT0001       | 2023-01-01 17:00:00 | eau            | 2.60           | m3      | 2023-01-01 17:00:00 |                 2.6  | 2023-01-01 |      17 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  8 | BAT0001       | 2023-01-01T20:00:00 | electricite    | 73.49          | kWh     | 2023-01-01 20:00:00 |                73.49 | 2023-01-01 |      20 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
|  9 | BAT0001       | 2023-01-01 23:00:00 | eau            | 0.20           | m3      | 2023-01-01 23:00:00 |                 0.2  | 2023-01-01 |      23 |    2023 |      1 |
+----+---------------+---------------------+----------------+----------------+---------+---------------------+----------------------+------------+---------+---------+--------+
2026-02-21 10:10:01,228 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 10:10:01,232 - [INFO] - [4/5] Agregations ...
2026-02-21 10:10:01,236 - [INFO] - Agregation 1 : Consommations horaires moyennes par batiment (df_horaire)
2026-02-21 10:11:22,990 - [INFO] - Apperçu de df_horaire :
+----+---------------+------------+---------+----------------+------------------------+---------+
|    | batiment_id   | date       |   heure | type_energie   |   consommation_moyenne | unite   |
+====+===============+============+=========+================+========================+=========+
|  0 | BAT0001       | 2023-01-06 |      18 | gaz            |                 426.39 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  1 | BAT0001       | 2023-01-17 |       0 | gaz            |                  57.36 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  2 | BAT0001       | 2023-02-08 |       4 | electricite    |                  22.68 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  3 | BAT0001       | 2023-02-28 |      18 | gaz            |                 373.14 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  4 | BAT0001       | 2023-03-25 |      10 | eau            |                   3.51 | m3      |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  5 | BAT0001       | 2023-04-08 |      23 | electricite    |                   4.51 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  6 | BAT0001       | 2023-04-14 |      17 | electricite    |                 207.31 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  7 | BAT0001       | 2023-06-22 |       6 | gaz            |                 238.41 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  8 | BAT0001       | 2023-08-08 |       0 | gaz            |                  23.66 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
|  9 | BAT0001       | 2023-09-02 |       7 | gaz            |                  45.39 | kWh     |
+----+---------------+------------+---------+----------------+------------------------+---------+
2026-02-21 10:11:22,994 - [INFO] - ---
2026-02-21 10:11:22,997 - [INFO] - Agregation 2 : Consommations journalieres (par date) par batiment et type d'energie
2026-02-21 10:12:43,277 - [INFO] - Apperçu de df_journaliere :
+----+---------------+------------+----------------+------------------------+---------+
|    | batiment_id   | date       | type_energie   |   consommation_moyenne | unite   |
+====+===============+============+================+========================+=========+
|  0 | BAT0001       | 2023-09-22 | electricite    |                 153.83 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  1 | BAT0001       | 2023-10-13 | electricite    |                 153.7  | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  2 | BAT0001       | 2024-03-26 | gaz            |                 242.97 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  3 | BAT0001       | 2024-05-21 | gaz            |                 248.3  | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  4 | BAT0001       | 2024-06-28 | electricite    |                 116.23 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  5 | BAT0001       | 2024-09-01 | gaz            |                 159.64 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  6 | BAT0001       | 2024-09-06 | electricite    |                 126.09 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  7 | BAT0001       | 2024-09-18 | eau            |                  10.2  | m3      |
+----+---------------+------------+----------------+------------------------+---------+
|  8 | BAT0001       | 2024-11-20 | gaz            |                 394.91 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
|  9 | BAT0002       | 2023-03-09 | gaz            |                  80.61 | kWh     |
+----+---------------+------------+----------------+------------------------+---------+
2026-02-21 10:12:43,282 - [INFO] - ---
2026-02-21 10:12:43,285 - [INFO] - Agregation 3 : Consommations mensuelles par commune
2026-02-21 10:14:02,516 - [INFO] - Apperçu de df_monthly_with_commune :
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|    | batiment_id   | type_energie   | unite   |   annee |   mois |   consommation_mean |   consommation_min |   consommation_max |   measurement_count | commune   |
+====+===============+================+=========+=========+========+=====================+====================+====================+=====================+===========+
|  0 | BAT0003       | eau            | m3      |    2023 |     11 |                5.56 |               0.13 |              14.3  |                 645 | Paris     |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  1 | BAT0005       | eau            | m3      |    2024 |      4 |              317.62 |              27.96 |             661.14 |                 660 | Paris     |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  2 | BAT0007       | gaz            | kWh     |    2023 |      4 |              132.82 |              10.19 |             423.71 |                 643 | Paris     |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  3 | BAT0013       | electricite    | kWh     |    2023 |     12 |              169.39 |               8.19 |             359.96 |                 687 | Lyon      |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  4 | BAT0015       | gaz            | kWh     |    2024 |      6 |               91.86 |               2.11 |             495.75 |                 646 | Lyon      |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  5 | BAT0023       | eau            | m3      |    2023 |      4 |                8.48 |               0.2  |              24.06 |                 661 | Marseille |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  6 | BAT0023       | electricite    | kWh     |    2024 |      9 |              144.27 |               3.29 |             563.2  |                 653 | Marseille |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  7 | BAT0031       | eau            | m3      |    2023 |      8 |                2.09 |               0.18 |               4.4  |                 690 | Marseille |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  8 | BAT0033       | eau            | m3      |    2023 |      7 |                2.16 |               0.19 |               4.47 |                 684 | Toulouse  |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
|  9 | BAT0035       | electricite    | kWh     |    2023 |     10 |               54.18 |               1.21 |             226.19 |                 671 | Toulouse  |
+----+---------------+----------------+---------+---------+--------+---------------------+--------------------+--------------------+---------------------+-----------+
2026-02-21 10:14:02,521 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 10:14:02,526 - [INFO] - [5/5] Sauvegarde ...
2026-02-21 10:14:02,530 - [INFO] - Sauvegarder en Parquet partitionne par date et type d'energie 
2026-02-21 10:15:22,567 - [INFO] - Ecriture en parquet ...
2026-02-21 10:42:45,123 - [INFO] - Ecriture en parquet terminée avec succès
2026-02-21 10:42:45,128 - [INFO] - Temps d'enregistrement en parquet : 1642.55 secondes
2026-02-21 10:42:45,132 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 10:42:45,136 - [INFO] - RAPPORT DE NETTOYAGE
2026-02-21 10:42:45,140 - [INFO] - Lignes en entree                  :    7,758,868
2026-02-21 10:42:45,143 - [INFO] - Timestamps invalides              :            0
2026-02-21 10:42:45,147 - [INFO] - Valeurs non numeriques            :       38,975
2026-02-21 10:42:45,152 - [INFO] - Valeurs negatives                 :       38,910
2026-02-21 10:42:45,157 - [INFO] - Outliers (>10000)                 :       38,560
2026-02-21 10:42:45,161 - [INFO] - Doublons                          :      646,475
2026-02-21 10:42:45,166 - [INFO] - Total lignes supprimees           :      762,920
2026-02-21 10:42:45,171 - [INFO] - Lignes apres agregation           :    6,995,937
2026-02-21 10:42:45,175 - [INFO] - Fichiers Parquet sauvegardes dans : /output/02_consommations_clean
2026-02-21 10:42:45,180 - [INFO] - ---
2026-02-21 10:42:45,185 - [INFO] - Temps d'exécution de ce script (02_nettoyage_spark.py) : 2921.06 secondes
2026-02-21 10:42:45,189 - [INFO] - Ressources machine approximatives allouées à ce traitement : (RAM : 13.49 GB, CPU : 99.30% - Approx logical cores free(15.89) - Approx physical cores free : 7.94)
2026-02-21 10:42:45,193 - [INFO] - 
2026-02-21 10:42:45,198 - [INFO] - Ecrire des données du temps d'execution + ressources dans le fichier tmp_02_resources.txt
2026-02-21 10:42:45,207 - [INFO] - ---
2026-02-21 10:42:45,213 - [INFO] - [ok]: Fin du traitement, le script a été exécuté avec succès
2026-02-21 10:42:45,221 - [INFO] - [ok]: cache de df_horaire libéré
2026-02-21 10:42:45,225 - [INFO] - ───────────────────────────────────────────────────────────────────────────────────────────────
2026-02-21 10:42:45,904 - [INFO] - [ok]: la session spark a ete arretee avec succes
2026-02-21 10:42:45,909 - [INFO] - ===============================================================================================
